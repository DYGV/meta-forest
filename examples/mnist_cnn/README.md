# Forest Example Project - Convolutional Neural Network for MNIST Digit Recognition

This example project consists of a convolutional neural network (CNN) running on the FPGA being applied to the MNIST digit recognition task.

## Requirements

## Introduction and Design Files

The ROS2-FPGA node generated by Forest in this example is used in the inference task of MNIST digit recognition. The neural network is trained
in a CPU by using TensorFlow Keras, and the weights and biases are saved in a file and stored in the FPGA using read-only memories (ROMs).

The neural network architecture used in this example is shown in the image below:

![arch](https://github.com/ros2-forest/forest/blob/master/examples/mnist_cnn/model_plot_cnn.png)

The setup for this example project consists of three ROS2 nodes. The first ROS2 node runs on a PC and publishes the MNIST dataset images. The second node is the Forest-generated ROS2-FPGA node, which runs on the Zynq board and performs digit recognition. The third node runs on the PC and receives the FPGA output prediction.

The files for this project are located in two directories: design_files/ and ros2_packages/, which are explained below:

### design_files/

This directory contains the HLS files for the project (.cpp and .h files), as well as the config.forest file that is provided to Forest. Note that some information in the config.forest file will need to be changed if you are using it in your own workspace, such as the Absolute ROS2 dev_ws path and Absolute FPGA .bit file path.
All of the .h files with the exception of mnist_cnn.h contain the weights and biases for the CNN's convolutional and fully connected layers. As explained before, these values were obtained by training the CNN model previously using TensorFlow Keras.

### ros2_packages/

This directory contains two ROS2 packages that should be built ***on your PC*** (not on the Zynq board). They are the packages that define the nodes that send and receive MNIST data to/from the FPGA. 

The node send.py reads images from the MNIST test dataset, publishes them to the fpga_in topic, and plots them. The node receive.py subscribes to the fpga_out topic, and prints the FPGA output prediction.

## Running the Example Project

This is a step-by-step of how to run the MNIST CNN example project.

1. Create a new Vivado HLS project and include the mnist_cnn.cpp and all .h files from the design_files/ folder. Synthesize the design and export it as an IP to Vivado.

2. Create a new block design in a new Vivado project and include the IP exported in Step 1. Also include the Zynq IP and a Vivado AXI Direct Memory Access (DMA) IP. Integrate the IPs and compile the design to generate a bitstream.

3. Move the generated bitstream and .hwh files, as well as the config.forest file in the design_files/ directory to your PYNQ system. The config.forest must be placed in the same folder as your forest.py file.

4. Update the config.forest file to use the location of the ROS2 dev_ws directory and of the .bit and .hwh files in your PYNQ file system.

5. Run Forest to generate the ROS2-FPGA node `python3 forest.py -t`

6. Move the two folders inside ros2_packages/ to the dev_ws/src location in your PC and build them.

7. In your PC, run the send and receive nodes in two different terminals.

```
ros2 run mnist_cnn_send receive

ros2 run mnist_cnn_send send
```

8. On PYNQ, run the ROS2-FPGA node.

```
ros2 run forest_mnist_cnn_fpga_node fpga_node
```

## Results

### Demo

- ADD VIDEO

### Latency Results

The following table shows the average latency per image observed when performing MNIST inference on the Digilent Zybo Z7-20 FPGA, 
and on an Intel Core i7-6500U processor:

| Device | Device Latency (ms) | Ratio (Device Latency:FPGA Latency) |
| :---:         |     ---:      |          ---: |
| Intel CPU     |     58.8 |     8.53:1 |
| FPGA   |    6.9 |     1:1|

### Accuracy Results

The following table shows the accuracy observed on the entire MNIST test dataset (10,000 images) of the Digilent Zybo Z7-20 FPGA, 
and of the Intel Core i7-6500U processor:

| Device | Accuracy |
| :---:         |     ---:      |
| Intel CPU     |     99.09 % |
| FPGA   |    99.04 % |

### Hardware Resource Usage

The following image shows the hardware resource usage reported by Vivado HLS for the MNIST CNN design.

![usage_cnn](https://github.com/ros2-forest/forest/blob/master/examples/mnist_cnn/mnist_cnn_usage.png)
